<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>ERC-20 contract tutorial with C# and Casper .NET SDK | C#/.Net SDK for the Casper Network </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="ERC-20 contract tutorial with C# and Casper .NET SDK | C#/.Net SDK for the Casper Network ">
    <meta name="generator" content="docfx 2.58.9.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
    
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../../index.html">
                Casper.Network.SDK
              </a>    </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="erc-20-contract-tutorial-with-c-and-casper-net-sdk">ERC-20 contract tutorial with C# and Casper .NET SDK</h1>

<p>This tutorial is a C# version of the <a href="https://casper.network/docs/erc20">ERC-20 contract tutorial</a>
available on the Casper Network website. You're encouraged to read that tutorial first to get acquainted with
the implementation of the ERC-20 standard for the Casper blockchain.</p>
<p>In this document, we'll show you how to use the Casper .NET SDK to:</p>
<ul>
<li>Deploy the ERC-20 contract example to the blockchain.</li>
<li>Transfer tokens to an account and get the balance of tokens.</li>
<li>Call the Approve function to allow a spender to transfer tokens from the owner account.</li>
</ul>
<p>Read first the <a href="../counter-contract/README.html">Counter tutorial</a> to prepare your environment and one account with
enough $CSPR to make deploys.</p>
<p>NOTE: We use a local network with NCTL in this example. Learn <a href="https://casper.network/docs/dapp-dev-guide/setup-nctl">here</a>
how to install your local network. Alternatively, you can easily adapt the code in this example to use the casper-test
network.</p>
<h3 id="step-1-deploy-the-key-value-storage-contract">Step 1. Deploy the key-value storage contract</h3>
<p>Clone the GitHub repository and build the contract following the instructions in the README file.</p>
<pre><code>git clone https://github.com/casper-ecosystem/erc20 
cd erc20
make prepare
make build-contracts
</code></pre>
<p>As a result, you will get the contract compiled at <code>target/wasm32-unknown-unknown/release/</code>. Copy the <code>erc20_token.wasm</code> file
to your working directory.</p>
<p>We used the <code>ContractDeploy</code> deploy template to prepare a <code>Deploy</code> object in other examples. To show what's behind that template,
we're showing here all the steps needed to prepare the deploy and send it to the network.</p>
<pre><code class="lang-csharp">public static async Task&lt;HashKey&gt; DeployERC20Contract(KeyPair accountKey)
{
    var wasmFile = &quot;./erc20_token.wasm&quot;;
    var wasmBytes = System.IO.File.ReadAllBytes(wasmFile);

    var header = new DeployHeader()
    {
        Account = accountKey.PublicKey,
        Timestamp = DateUtils.ToEpochTime(DateTime.UtcNow),
        Ttl = 1800000,
        ChainName = chainName,
        GasPrice = 1
    };
    var payment = new ModuleBytesDeployItem(300_000_000_000);

    List&lt;NamedArg&gt; runtimeArgs = new List&lt;NamedArg&gt;();
    runtimeArgs.Add(new NamedArg(&quot;name&quot;, &quot;C# SDK Token&quot;));
    runtimeArgs.Add(new NamedArg(&quot;symbol&quot;, &quot;CSSDK&quot;));
    runtimeArgs.Add(new NamedArg(&quot;decimals&quot;, (byte) 5)); //u8
    runtimeArgs.Add(new NamedArg(&quot;total_supply&quot;, CLValue.U256(10_000)));

    var session = new ModuleBytesDeployItem(wasmBytes, runtimeArgs);

    var deploy = new Deploy(header, payment, session);
    deploy.Sign(accountKey);

    await casperSdk.PutDeploy(deploy);

    var tokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(120));
    var deployResponse = await casperSdk.GetDeploy(deploy.Hash, tokenSource.Token);

    var execResult = deployResponse.Parse().ExecutionResults.First();

    Console.WriteLine(&quot;Deploy COST : &quot; + execResult.Cost);

    var contractHash = execResult.Effect.Transforms.First(t =&gt;
        t.Type == TransformType.WriteContract).Key;
    Console.WriteLine(&quot;Contract key: &quot; + contractHash);

    File.WriteAllText(&quot;res_DeployERC20Contract.json&quot;, deployResponse.Result.GetRawText());

    return (HashKey) contractHash;
}
</code></pre>
<h3 id="step-2-read-the-balance-of-an-account">Step 2. Read the balance of an account</h3>
<p>The account that has deployed the contract owns the total supply of tokens. We can read the balance of an account
making a query to the <code>balances</code> dictionary.</p>
<pre><code class="lang-csharp">public static async Task ReadBalance(string contractHash, PublicKey publicKey)
{
    var accountHash = new AccountHashKey(publicKey);
    var dictItem = Convert.ToBase64String(accountHash.GetBytes());
    
    var response = await casperSdk.GetDictionaryItemByContract(contractHash, &quot;balances&quot;, dictItem);

    File.WriteAllText(&quot;res_ReadBalance.json&quot;, response.Result.GetRawText());

    var result = response.Parse();
    var balance = result.StoredValue.CLValue.ToBigInteger();
    Console.WriteLine(&quot;Balance: &quot; + balance.ToString() + &quot; $CSSDK&quot;);
}
</code></pre>
<h3 id="step-3-transfer-tokens-to-another-account">Step 3. Transfer tokens to another account</h3>
<p>To transfer tokens to another account, the owner calls the 'transfer' entry point indicating the recipient and the
number of tokens to send.</p>
<pre><code class="lang-csharp">public static async Task TransferTokens(string contractHash, KeyPair ownerAccount, PublicKey recipientPk,
            ulong amount)
{
    var deploy = DeployTemplates.ContractCall(new HashKey(contractHash),
        &quot;transfer&quot;,
        new List&lt;NamedArg&gt;()
        {
            new NamedArg(&quot;recipient&quot;, CLValue.Key(new AccountHashKey(recipientPk))),
            new NamedArg(&quot;amount&quot;, CLValue.U256(amount))
        },
        ownerAccount.PublicKey,
        1_000_000_000,
        chainName);
    deploy.Sign(ownerAccount);

    await casperSdk.PutDeploy(deploy);

    var tokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(120));
    var deployResponse = await casperSdk.GetDeploy(deploy.Hash, tokenSource.Token);

    File.WriteAllText(&quot;res_TransferTokens.json&quot;, deployResponse.Result.GetRawText());
}
</code></pre>
<h3 id="step-4-approve-an-spender-to-transfer-tokens-from-your-account">Step 4. Approve an spender to transfer tokens from your account</h3>
<p>The <code>approve</code> function purpose in the ERC-20 contract is to approve an address to spend tokens on behalf of the
approver account. In other words, the owner of an account <code>A</code> approves that a spender with account <code>B</code> can transfer
tokens from <code>A</code>  to any recipient's account (up to a maximum limit).</p>
<pre><code class="lang-csharp">public async static Task ApproveSpender(string contractHash, KeyPair ownerAccount, PublicKey spenderPk, ulong amount)
{
    var deploy = DeployTemplates.ContractCall(new HashKey(contractHash),
        &quot;approve&quot;,
        new List&lt;NamedArg&gt;()
        {
            new NamedArg(&quot;spender&quot;, CLValue.Key(new AccountHashKey(spenderPk))),
            new NamedArg(&quot;amount&quot;, CLValue.U256(amount))
        },
        ownerAccount.PublicKey,
        1_000_000_000,
        chainName);
    deploy.Sign(ownerAccount);

    await casperSdk.PutDeploy(deploy);

    var tokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(120));
    var deployResponse = await casperSdk.GetDeploy(deploy.Hash, tokenSource.Token);

    File.WriteAllText(&quot;res_ApproveSpender.json&quot;, deployResponse.Result.GetRawText());
}
</code></pre>
<p>After approval, the spender has an allowance. This value can be checked by querying the <code>allowances</code> dictionary
of the contract. Since a spender may have allowances from different owners, the key in the dictionary contains
both the owner and the spender accounts.</p>
<pre><code class="lang-csharp">public static async Task ReadAllowance(string contractHash, PublicKey ownerPk, PublicKey spenderPk)
{
    var ownerAccHash = new AccountHashKey(ownerPk);
    var spenderAccHash = new AccountHashKey(spenderPk);
    var bytes = new byte[ownerAccHash.GetBytes().Length + spenderAccHash.GetBytes().Length];
    Array.Copy(ownerAccHash.GetBytes(), 0, bytes, 0, ownerAccHash.GetBytes().Length);
    Array.Copy(spenderAccHash.GetBytes(), 0, bytes, ownerAccHash.GetBytes().Length,
        spenderAccHash.GetBytes().Length);

    var bcBl2bdigest = new Org.BouncyCastle.Crypto.Digests.Blake2bDigest(256);
    bcBl2bdigest.BlockUpdate(bytes, 0, bytes.Length);
    var hash = new byte[bcBl2bdigest.GetDigestSize()];
    bcBl2bdigest.DoFinal(hash, 0);

    var dictItem = Hex.ToHexString(hash);

    var response = await casperSdk.GetDictionaryItemByContract(contractHash, &quot;allowances&quot;, dictItem);

    File.WriteAllText(&quot;res_ReadAllowance.json&quot;, response.Result.GetRawText());

    var result = response.Parse();
    var balance = result.StoredValue.CLValue.ToBigInteger();
    Console.WriteLine(&quot;Allowance: &quot; + balance.ToString() + &quot; $CSSDK&quot;);
}
</code></pre>
<h3 id="step-5-transfer-tokens-from-the-allowance">Step 5. Transfer tokens from the allowance</h3>
<p>A spender can transfer tokens from the owner to a recipient using the <code>transfer_from </code> entry point in the ERC-20 contract.</p>
<pre><code class="lang-csharp">public static async Task TransferTokensFromOwner(string contractHash, KeyPair spenderAccount, 
    PublicKey ownerPk, PublicKey recipientPk, ulong amount)
{
    var deploy = DeployTemplates.ContractCall(new HashKey(contractHash),
        &quot;transfer_from&quot;,
        new List&lt;NamedArg&gt;()
        {
            new NamedArg(&quot;owner&quot;, CLValue.Key(new AccountHashKey(ownerPk))),
            new NamedArg(&quot;recipient&quot;, CLValue.Key(new AccountHashKey(recipientPk))),
            new NamedArg(&quot;amount&quot;, CLValue.U256(amount))
        },
        spenderAccount.PublicKey,
        1_000_000_000,
        chainName);
    deploy.Sign(spenderAccount);

    await casperSdk.PutDeploy(deploy);

    var tokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(120));
    var deployResponse = await casperSdk.GetDeploy(deploy.Hash, tokenSource.Token);

    File.WriteAllText(&quot;res_TransferFromOwner.json&quot;, deployResponse.Result.GetRawText());
}
</code></pre>
<p>The amount of tokens sent to the recipient is deducted from the allowance approved by the owner. You can verify this
by rereading the allowance with <code>ReadAllowance()</code>.</p>
<h3 id="step-6-check-the-balance-or-the-allowance-of-any-account">Step 6. Check the balance or the allowance of any account</h3>
<p>When we check the balance or the allowance of an account, we query a dictionary in the contract. Suppose the key that
identifies an account owner or the pair owner-spender does not exist in the balances or allowances dictionary,
respectively. Our call to the <code>GetDictionaryItemByContract</code> RPC method will throw an error.</p>
<p>To capture this error, wrap the RPC call in a try-catch block.</p>
<pre><code class="lang-csharp">try
{
    var response = await casperSdk.GetDictionaryItemByContract(contractHash, &quot;balances&quot;, dictItem);

    File.WriteAllText(&quot;res_ReadBalance.json&quot;, response.Result.GetRawText());

    var result = response.Parse();
    var balance = result.StoredValue.CLValue.ToBigInteger();
    Console.WriteLine(&quot;Balance: &quot; + balance.ToString() + &quot; $CSSDK&quot;);
}
catch (RpcClientException e)
{
    if (e.RpcError.Code == -32003)
        Console.WriteLine(&quot;Allowance not found!&quot;);
    else
        throw;
}
</code></pre>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            Maintained by MAKE Technology LLC
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
